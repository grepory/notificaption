# notificaption
[![Circle CI](https://circleci.com/gh/opsee/notificaption.svg?style=shield&circle-token=91edb2373c7b6cfb53108cdc135ef6623e3ba56c)](https://circleci.com/gh/opsee/notificaption) [![Docker Repository on Quay](https://quay.io/repository/opsee/notificaption/status?token=3efac0f6-ffe0-48cd-92d0-3a4620b0f981 "Docker Repository on Quay")](https://quay.io/repository/opsee/notificaption)

The notificaption service takes screenshots of failing checks in Emissary to be sent with notifications. Screenshots result in a more consistent appearance across notification mediums (Slack vs. email). 

Notificaption uses [NightmareJS](https://github.com/segmentio/nightmare) for taking the screenshots, making requests against production Emissary. All screenshots are stored in S3. 

## API
#### `POST /screenshot`
Screenshots can be generated by `POST`ing data on a failing check to the `/screenshot` endpoint. The following two gists contain examples of the request data you should be `POST`ing: [3p4KOGif2SuPQW5YWn2zTu](https://gist.github.com/doeg/c7753a038e79ed83db9e) and  [21G057gL7oNtKKDW64g9Dl](https://gist.github.com/doeg/00ce3ce7dacf6bce570e). 

In return, you'll receive S3 URLs to the generated images and the check JSON:

```json
{
  "images": {
    "default": "https://opsee-notificaption-images.s3.amazonaws.com/21G057gL7oNtKKDW64g9Dl_1454446492972_100.png"
  },
  "json_url": "https://opsee-notificaption-images.s3.amazonaws.com/21G057gL7oNtKKDW64g9Dl_1454446492972.json"
}
```

#### `GET /checks/{{checkID}}.json`
Returns the JSON data on the check with the given ID. The data returned by this endpoint is the same data posted by Beavis in the screenshot request, which is stored in memory by the server whenever a screenshot request is received. Emissary makes requests to this endpoint to populate the screenshot page.

#### `GET /health`
Returns an empty response with a 200 status code, when operating normally. Used for AWS health checks. 

## Local development
1. Add your AWS credentials to your environment: ` export AWS_ACCESS_KEY_ID='AKID'; export AWS_SECRET_ACCESS_KEY='SECRET'`
1. Install the dependencies: `npm install`
1. Start up the server: `npm start`. (You can also use `nodemon server.js`, although this might spawn a ton of Electron subprocesses.)
1. Check `http://localhost:9099` to make sure it's up.
1. Make sure you have Emissary running. You can adjust the host, port, and the like for your Emissary service by editing the config file you're using, found in the `config/` folder. 
1. Start screenshotting by `POST`ing to `http://localhost:9099/screenshot`. 

## Deployment
1. Build the Docker image and push it to quay.io: `npm run docker-publish`
1. From the [`compute` repo](https://github.com/opsee/compute): `./run deploy production notificaption latest`

### Troubleshooting deploys
All notificaption logs show up in [Papertrail](https://papertrailapp.com/groups/1993213/events?q=notificaption).

If the service is failing, make sure notificaption is playing nice with Docker by running it locally:

1. Build the docker image locally: `npm run docker-build`
1. Start up the docker image: `npm run docker-run`
1. Get the IP address of the local docker-machine: `docker-machine ip default` (e.g., 123.4.5.6)
1. Try hitting `123.4.5.6:9099`
